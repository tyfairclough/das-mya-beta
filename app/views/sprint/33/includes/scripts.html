<!-- govuk_frontend_toolkit js -->
<script src="/public/javascripts/vendor/polyfills/bind.js"></script>

<script src="/public/javascripts/govuk/shim-links-with-button-role.js"></script>
<script src="/public/javascripts/govuk/show-hide-content.js"></script>

<!-- govuk_elements js -->
<script src="/public/javascripts/govuk/details.polyfill.js"></script>
<script src="/public/javascripts/application.js"></script>
<script src="/public/javascripts/stackable.min.js"></script>
<script src="/public/javascripts/zxcvbn.js"></script>
<script src="/public/javascripts/hammer.min.js"></script>
<script src="https://getaddress.io/js/jquery.getAddress-2.0.5.min.js"></script>

<script src="/public/javascripts/aml.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css" integrity="sha256-gl80aFE+bSTFw7UJf+ne/RkwC55cjidIp0Oe3AX5pfo=" crossorigin="anonymous" />
<script>
    $(document).ready(function () {




        if (localStorage.getItem("organisations") === null) {
            //    console.log("no orgs founddddd");
            var newCompany = [];
            var newCompanyDetails = {};
            newCompanyDetails.name = "Acme Ltd2";
            newCompanyDetails.signed = 0;
            newCompany.push(JSON.stringify(newCompanyDetails));
            //  console.log(newCompany);    
            localStorage.setItem("organisations", JSON.stringify(newCompany));
        }



        //GLOBAL VAR
        var XMLSource = $('#search').attr('xmlData');
        var keyword = '';
        var catType = '';
        var stn = '';
        var frm = '';

        var i = 0;
        var msgPlural = 'are';

        var paginateCount = 5;
        var className = $("#content").attr('class');


        switch (className) {
        case 'index':
            // reset site
            localStorage.setItem("onboarding", "0");
            localStorage.setItem("sessionState", "0");
                indexV1();
            break;
        case 'manual-input':
            manualInputName();
            break;
        case 'public-sector':
            // put directory stuff here

            break;
        case 'account-dashboard-7':
            accountDash7();
            break;
        case 'public-sector-search':
            // put search keyword stuff here
            break;
        case 'organisations-add':
            organisationAdd();
            break;
        case 'organisations-address':
            $(".button").click(function (e) {
                e.preventDefault();
                localStorage.setItem("organisation-address", JSON.stringify($("#address").val()));
                window.location.href = "/sprint/{{sprint}}/account/organisations/confirm.html?orgtype=";
            });
            break;
        case 'organisations-address-manual':
            // manual stuff
            organisationsAddressManual();
            break;
        case 'organisations-type-manual':
            organisationsTypeManual();
            break;
        case 'test':
            getCompaniesHouse();
            break;
        case 'organisations-chquestion':
            $(".button").click(function (e) {
                e.preventDefault();
                chQuestion();
            })
            break;
        case 'organisations-question':
            $(".button").click(function (e) {
                e.preventDefault();
                orgQuestion();
            })
            break;
        case 'organisations-index':
            organisationsIndex();
            break;
        case 'before-you-start':
            $(".button").click(function (e) {
                e.preventDefault();
                areYouReady();
            })
            break;
        case 'rename-account':
            renameAccount();
            break;
        case 'check-mail':
            //checkMail();
            break;
        case 'sign-agreement':
            signAgreement();
            break;
        case 'zxcvbn':
            captureUserData();
            passwordPeek();
            break;
        case 'login':
            loginUser();
            break;
        case 'test-react-test':
            testReactCountdown();
            break;
        case 'test-react-instructions':
            localStorage.setItem("reactLoop", "1");
            break;
        case 'confirm':
            confirmDetails();
            break;
        case 'provider-index':
            providerIndex();
            break;
        case 'your-cohorts':
            yourCohorts();
            break;
        case 'finished-editing':
            finishedEditing();
            break;
        case 'approve-cohorts':
            approveCohorts();
            break;
        case 'confirm-your-business-relationship':
            confirmYourBusinessRelationship();
            break;
        case 'confirm-your-organisation-relationship':
            confirmYourOrganisationRelationship();
            break;
        case 'confirm-employer':
            confirmEmployer();
            break;
        case 'funding-index':
            break;
        case 'first-approval':
            firstApproval();
            break;
        case 'organisations-remove':
            removeOrgIndex();
            break;
        case 'organisations-remove-confirm':
            removeOrgConfirm2();
            break;
        case 'invite-new':
            inviteNew();
            break;
        case 'account-dashboard':
            accountDashboard();
            break;
        case 'account-forecast':
            accountForecast();
            break;
        case 'forecast-index':
            forecastIndex();
            break;
        case 'account-dash-8':
            accountDash8();
            break;
        default:
            break;
        };
        
        
        function indexV1(){
            
            
            $('input').keypress(function(e){
                if(e.which == 13){//Enter key pressed
                e.preventDefault();
                indexSwitch();
                }
            });
            
            $(".button").click(function (e) {
                e.preventDefault();
                indexSwitch();
            });
            
            function indexSwitch() {
                console.log("done");
                var email = $("#email-address").val();
                
                if (email == ("ty.fairclough@gmail.com" || "pritesh.patel@digital.education.gov.uk")) {
                    window.location.href = "/sprint/{{sprint}}/user/login.html";                    
                } else {
                    // store field inputs into local storage
                    localStorage.setItem("user.email", JSON.stringify(email));
                    //console.log(localStorage.getItem("user.email"));
                    window.location.href = "/sprint/{{sprint}}/onboarding/zxcvbn.html";
                }
            }   
        }


        function accountDash7() {
            $("#add-paye, #add-org, #invite-users, .done, #welcome .panel").hide();

localStorage.setItem("onboarding",0);
            var orgArray = [];
            orgArray = JSON.parse(localStorage.getItem("organisations"));
            console.log(orgArray[0]);
            orgObj = orgArray.splice(0, 1);
            console.log(orgObj);

            var orgParse = JSON.parse(orgObj)

            console.log(orgParse.signed);

            if (orgParse.signed === 1) {
                $("#sign-agreement .todo, #add-paye .panel").hide();
                $("#sign-agreement .done, #add-paye").show();
            }

            $("#add-paye form label").click(function (e) {
                //e.preventDefault();  
                var state = $('input[name=add-paye-group]:checked').val();

                if (state === "1") {
                    $("#add-paye .todo").hide();
                    $("#add-org, #add-paye .done").show();
                } else {
                    $("#add-paye .todo .panel").fadeIn();
                }
            });

            $("#add-org form label").click(function (e) {
                var state = $("input[name=add-org-group]:checked").val();

                if (state === "1") {
                    $("#add-org .todo").hide();
                    $("#add-org .done, #invite-users").show();
                } else {
                    $("#add-org .panel").show();
                }
            });

            $("#invite-users form label").click(function (e) {

                var state = $("input[name=invite-users-group]:checked").val();
                console.log("state is " + state)
                if (state === "1") {
                    $("#invite-users .panel:first").show();
                    $("#invite-users .panel + .panel").hide();
                } else {
                    $("#invite-users .panel:first").hide();
                    $("#invite-users .panel + .panel").show();
                }
            })
        }

        function accountDashboard() {
        }

        function inviteNew() {


            // version without drop down

            $(".acl").removeClass("hidden");
            $(".preset-roles").addClass("hidden");
            $("label").removeClass('selected');

            $("label").click(function (e) {
                    e.preventDefault();
                    $(this).parents("tr").find("label").removeClass("selected");
                    $(this).addClass("selected");
                })
        }

        function removeOrgConfirm2() {





            $("#action").click(function (e) {
                e.preventDefault();
                //get the number of the row
                //var rowNum = $(this).attr("id");
                var rowNum = getQueryVariable("orgId");



                var orgArray = [];
                orgArray = JSON.parse(localStorage.getItem("organisations"));

                orgArray.splice(rowNum, 1);
                localStorage.setItem("organisations", JSON.stringify(orgArray));
                window.location.href = "/sprint/{{sprint}}/account/organisations/index.html?removeMsg=y";
            });
        }

        function firstApproval() {
            $(".button").click(function (e) {
                e.preventDefault();
                var state = $('input[name=radio-group]:checked').val();

                if (state == "1") {
                    window.location.href = "/sprint/{{sprint}}/providers/memo.html";
                } else {
                    window.location.href = "/sprint/{{sprint}}/providers/cohort-approve.html";
                }
            })
        }

        function confirmYourOrganisationRelationship() {
            $(".button").click(function (e) {
                e.preventDefault();
                window.location.href = "/sprint/{{sprint}}/providers/review-your-cohort.html";
            })
        }

        function confirmEmployer() {
            $(".button").click(function (e) {
                e.preventDefault();
                var state = $('input[name=radio-group]:checked').val();

                if (state == "1") {
                    window.location.href = "/sprint/{{sprint}}/providers/first-approval.html";
                } else {
                    window.location.href = "/sprint/{{sprint}}/providers/advice-confirm-identity.html";
                }
            })
        }

        function confirmYourBusinessRelationship() {
            $(".button").click(function (e) {
                e.preventDefault();

                var state = $('input[name=radio-group]:checked').val();

                if (state == "1") {
                    // if they don't know their employer
                    window.location.href = "/sprint/{{sprint}}/providers/confirm-your-organisation-relationship.html";
                    localStorage.setItem("employerKnown", 1);
                } else {
                    // if they are a regular employer
                    window.location.href = "/sprint/{{sprint}}/providers/advice-confirm-identity.html";
                    localStorage.setItem("employerKnown", 2);
                };
            });
        };

        function approveCohorts() {
            $("a").click(function (e) {
                e.preventDefault();
                window.location.href = "/sprint/{{sprint}}/providers/confirm-your-business-relationship.html"
            })
        };


        function getCompaniesHouse() {

            // get companies house number

            $.ajax({
                url: 'https://api.companieshouse.gov.uk/company/09963675',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("0IJg_twH_cNHRQ4TufRhHhKW72_W8xdgijXsHDyI:")
                },
                success: function (data) {
                    alert(data);
                    //process the JSON data etc
                }
            });
        }



        function providerIndex() {

            $(".button").click(function (e) {
                e.preventDefault();
                var state = $('input[name=radio-group]:checked').val();

                if (state == "1") {
                    // if they have already approved a commitment
                    window.location.href = "/sprint/{{sprint}}/providers/your-cohorts.html";
                    localStorage.setItem("providerAgreement", 1);
                } else {
                    // if they haven't go to contract of service
                    window.location.href = "/sprint/{{sprint}}/providers/your-cohorts.html";
                    localStorage.setItem("providerAgreement", 0);
                }
            });

        };

        function yourCohorts() {


            var state = localStorage.getItem("providerAgreement");

            if (state == 1) {
                $(".alert-default-blue-thing").hide();
            }


            $("#button").click(function (e) {
                e.preventDefault();
                var state = localStorage.getItem("providerAgreement");

                if (state == 1) {
                    // if they have already approved a commitment
                    window.location.href = "/sprint/{{sprint}}/providers/approve-cohorts.html";
                } else {
                    // if they haven't go to contract of service
                    window.location.href = "/sprint/{{sprint}}/providers/no-agreement.html";
                }
            });
        };


        function finishedEditing() {
            //switch which option to show  
            var state = localStorage.getItem("providerAgreement");
            if (state == 1) {
                //signed
                $("form.state-1").show();
                $("form.state-2").hide();
            } else {
                //not signed
                $("form.state-1").hide();
                $("form.state-2").show();
            }


            $(".button").click(function (e) {
                e.preventDefault();

                var state = $('input[name=radio-group]:checked').val();


                if (state == "1") {
                    //approve logic
                    var employerKnown = localStorage.getItem("employerKnown");
                    // if they send for approval then we also ask if its a known employer
                    // if they have already approved a commitment
                    if (employerKnown == "1") {
                        //then ask if its the first approval logic page
                        window.location.href = "/sprint/{{sprint}}/providers/confirm-employer.html";
                    } else {
                        // is this the first appproval
                        window.location.href = "/sprint/{{sprint}}/providers/first-approval.html";
                    }

                } else if (state == "2" || state == "4") {
                    // send for review
                    window.location.href = "/sprint/{{sprint}}/providers/memo.html";
                } else if (state == "3" || state == "5") {
                    window.location.href = "/sprint/{{sprint}}/providers/cohort-save.html"
                }

            });
        };
        
        // Global string replacements    
        //$(".orgnumber").text(JSON.parse(localStorage.getItem("organisation-number")));
        //$(".organisation-name, .company-name").text(JSON.parse(localStorage.getItem("organisation-name")));
        //$(".organisation-name, .company-name").val(JSON.parse(localStorage.getItem("organisation-name")));



        if (JSON.parse(localStorage.getItem("user.name")) != "") {
            $(".user-name").text(JSON.parse(localStorage.getItem("user.name")));
        } else {
            $(".user-name").text("Your profile");
        }

        $(".organisation-address").text(JSON.parse(localStorage.getItem("organisation-address")));
        // my functions
        $('.review-agreement-button').on('click', function (e) {
            localStorage.setItem("signAgreementFor", $(this).data('org-index'));
        });

        function confirmDetails() {
            $(".button").click(function (e) {
                e.preventDefault();
                //var orgName = JSON.parse(localStorage.getItem("organisation-name"));
                //addOrg(orgName);
                //console.log(orgName);
                var onboarding = JSON.parse(localStorage.getItem("onboarding"));

                if (onboarding == 1) {
                    window.location.href = "/sprint/{{sprint}}/account/dashboard/index.html?accountCreated=y";
                } else {
                    window.location.href = "/sprint/{{sprint}}/account/organisations/next.html?orgAdded=y";
                }
            });
        }


        function removeOrgConfirm(i) {
            $("table a.remove").click(function (e) {
                e.preventDefault();
                //get the number of the row
                var rowNum = $(this).attr("id");
                //var rowNum = $(this).id;
                // splice that row
                console.log(rowNum);
                orgArray.splice(rowNum, 1);
                localStorage.setItem("organisations", JSON.stringify(orgArray));
                window.location.href = "/sprint/{{sprint}}/account/organisations/index.html";
            });
        }

        function removeOrgIndex(i) {
            if (localStorage.getItem("organisations") === null) {
                console.log("no orgs found")
            } else {
                var orgArray = [];
                orgArray = JSON.parse(localStorage.getItem("organisations"));

                var $table = $("<table class='table'></table>");
                var $head = $("<thead><tr><th scope='col' style='padding-top:0'>Organisation</th><th></th></tr></thead>");
                $table.append($head);



                if (orgArray.length == 1) {
                    //alert("show there's only 1 org");

                    orgName = JSON.parse(orgArray[0]);

                    var $line = $("<tr></tr>");
                    $line.append($("<td>" + orgName.name + "</td>"));
                    $line.append($("<td>Can’t be removed because it's the only organisation on your account.</td>"));
                    //$line.append( $( "<td class='numeric'><a href='/sprint/{{sprint}}/account/organisations/sign.html' id='"+i+"' class='remove'>Remove</a></td>" ) );
                    $table.append($line);

                } else {


                    for (var i = 0; i < orgArray.length; i++) {

                        orgName = JSON.parse(orgArray[i]);

                        var $line = $("<tr></tr>");

                        // this is if it is disabled 

                        if (orgName.signed != 0) {
                            // this is if its enabled
                            //$line.append( $( "<td><a href='#'></a></td>" ).html( orgName ) );
                            $line.append($("<td>" + orgName.name + "</td>"));
                            $line.append($("<td>Can’t be removed because it has ongoing apprenticeships.</td>"));
                            //$line.append( $( "<td class='numeric'><a href='/sprint/{{sprint}}/account/organisations/sign.html' id='"+i+"' class='remove'>Remove</a></td>" ) );
                            $table.append($line);
                            continue;
                        }
                        $line.append($("<td>" + orgName.name + "</td>"));
                        $line.append($("<td><a data-org-index=" + i + " href='/sprint/{{sprint}}/account/organisations/remove-org-confirm.html?orgId=" + i + "'>Remove</a></td>"));
                        $table.append($line);


                    }
                };

                $table.appendTo(document.body);

                // if you want to insert this table in a div with id attribute 
                // set as "myDiv", you can do this:
                $table.appendTo($("#orgTable"));

            }
            var orgArray = []
            orgArray = JSON.parse(localStorage.getItem("organisations"));
            //            console.log(orgArray);
            $("table a.remove").click(function (e) {
                e.preventDefault();
                //get the number of the row
                var rowNum = $(this).attr("id");
                //var rowNum = $(this).id;
                // splice that row
                console.log(rowNum);
                orgArray.splice(rowNum, 1);
                localStorage.setItem("organisations", JSON.stringify(orgArray));
                window.location.href = "/sprint/{{sprint}}/account/organisations/index.html";
            });

            $("table a").click(function (e) {
                e.preventDefault();
                var orgName = $(this).closest("td").prev("td").text();
                var orgId = $(this).attr("data-org-index");
                localStorage.setItem("organisation-name", JSON.stringify(orgName));
                window.location.href = "/sprint/{{sprint}}/account/organisations/remove-org-confirm.html?orgId=" + orgId;
            });

            userName();

        }

        function organisationsIndex(i) {


            //sessionState = localStorage.setItem("onboarding","0");            
            if (removeMsg == "y") {
                $("#removeOrgMsg").removeClass("hidden");
            }



            if (localStorage.getItem("organisations") === null) {
                console.log("no orgs found")
            } else {
                var orgArray = [];
                orgArray = JSON.parse(localStorage.getItem("organisations"));

                var $table = $("<table class='table'></table>");
                var $head = $("<thead><tr><th scope='col' style='padding-top:0'>Organisation</th><th>Spending status</th><th></th></tr></thead>");
                $table.append($head);


                for (var i = 0; i < orgArray.length; i++) {



                    orgName = JSON.parse(orgArray[i]);

                    var $line = $("<tr></tr>");

                    // this is if it is disabled 

                    if (orgName.signed != 0) {
                        // this is if its enabled
                        //$line.append( $( "<td><a href='#'></a></td>" ).html( orgName ) );
                        $line.append($("<td>" + orgName.name + "</td>"));
                        $line.append($("<td>Spending enabled<div style='color:#6F777B' class='font-xsmall'>SFA agreement signed by <span class='user-name'>Maxim Baby</span>, <span class='today'>" + orgName.date + "</span></div></td>"));

                        $line.append($("<td class='numeric'><a class='button text-link' href='/sprint/{{sprint}}/account/organisations/agreement-cover-signed.html'>Details</a></td>"));
                        //$line.append( $( "<td class='numeric'><a href='/sprint/{{sprint}}/account/organisations/sign.html' id='"+i+"' class='remove'>Remove</a></td>" ) );
                        $table.append($line);
                        continue;
                    }
                    $line.append($("<td>" + orgName.name + "</td>"));
                    $line.append($("<td>Spending disabled<div style='color:#6F777B' class='font-xsmall'>SFA agreement not yet signed</div></td>"));

                    $line.append($("<td class='numeric'><a href='/sprint/{{sprint}}/account/organisations/agreement-cover-sign.html' class='button secondary review-agreement-button' data-org-index='" + i + "'>Sign agreement</a></td>"));
                    //$line.append( $( "<td class='numeric'><a href='/sprint/{{sprint}}/account/organisations/sign.html' id='"+i+"' class='remove'>Remove</a></td>" ) );
                    $table.append($line);


                }


                $table.appendTo(document.body);

                // if you want to insert this table in a div with id attribute 
                // set as "myDiv", you can do this:
                $table.appendTo($("#orgTable"));

            }
            var orgArray = []
            orgArray = JSON.parse(localStorage.getItem("organisations"));
            console.log(orgArray);
            $("table a.remove").click(function (e) {
                e.preventDefault();
                //get the number of the row
                var rowNum = $(this).attr("id");
                //var rowNum = $(this).id;
                // splice that row
                console.log(rowNum);
                orgArray.splice(rowNum, 1);
                localStorage.setItem("organisations", JSON.stringify(orgArray));
                window.location.href = "/sprint/{{sprint}}/account/organisations/index.html";
            });

            userName();

        }

        function loginUser() {
            $(".button").click(function (e) {
                e.preventDefault();
                sessionState = localStorage.setItem("sessionState", "1");
                sessionState = localStorage.setItem("onboarding", "0");
                window.location.href = "/sprint/{{sprint}}/account/dashboard/index.html";
            });
        }

        function organisationsTypeManual() {
            $(".button").click(function (e) {
                e.preventDefault();
                window.location.href = "/sprint/{{sprint}}/account/organisations/address.html";
            })
        }

        function organisationsAddressManual() {

            $(".error-summary, .error-summary li, .error-message").hide();
            $(".form-group").removeClass("error");
            $(".manual-entry").hide();


            $('#postcode_lookup').getAddress({
                api_key: 'PZ3nAXOYLE-eWh1OqQNuZw8517',
                output_fields: {
                    line_1: '#line1',
                    line_2: '#line2',
                    line_3: '#line3',
                    post_town: '#town',
                    county: '#county',
                    postcode: '#postcode'
                },
                button_class: 'button',
                input_class: 'form-control',
                select_class: 'select2',

                onLookupSuccess: function (data) {
                    alert("success")
                },
                onLookupError: function () {
                    $(".manual-entry").show();
                },
                onAddressSelected: function (elem, index) {
                    $(".manual-entry").show();
                }
            });


        }


        function manualInputName() {
            $(".error-summary, .error-message").addClass("hidden");
            $(".form-group").removeClass("error");

            $(".button").click(function (e) {
                e.preventDefault();
                var orgName = $("#name").val();
                //addOrg(orgName);

                localStorage.setItem("organisation-name", JSON.stringify(orgName));
                window.location.href = "/sprint/{{sprint}}/account/organisations/address.html";
            })

        }


        function addOrg(orgName) {

            // This function takes a name and adds it to a list of organisations in an array
            var orgArray = new Array;

            var newOrg = '{"name":"' + orgName + '","signed":0}';

            //find out if there is a local storage for orgs already
            if (localStorage.getItem("organisations") === null) {
                orgArray.push(newOrg);
                localStorage.setItem("organisations", JSON.stringify(orgArray));

            } else {
                //orgArray = JSON.parse("["+localStorage.getItem("organisations")+"]");
                orgArray = JSON.parse(localStorage.getItem("organisations"));
                //orgArray.push(orgName);
                orgArray.push(newOrg);
                localStorage.setItem("organisations", JSON.stringify(orgArray));
            }
        }
        

        function captureUserData() {
                $("#email-address").val(JSON.parse(localStorage.getItem("user.email")));
            $(".zxcvbn .button").click(function (e) {
                e.preventDefault();
                var name = $("#users-name").val();
                var email = $("#email-address").val();
                var password = $("#password").val();
                if (email == "joe.bloggs@gmail.com") {
                    $("#emailGroup").addClass("error");
                    $("#emailError1").show().removeClass("hidden");
                    $(".error-summary").show().removeClass("hidden");

                } else {
                    // store field inputs into local storage
                    localStorage.setItem("user.name", JSON.stringify(name));
                    localStorage.setItem("user.email", JSON.stringify(email));
                    localStorage.setItem("user.password", JSON.stringify(password));
                    window.location.href = "/sprint/{{sprint}}/onboarding/check-mail.html";
                }
            });
        }


        headerNav();

        function headerNav() {
            var sessionState = localStorage.getItem("sessionState");
            if (sessionState == "1") {
                // if you're logged in
                $("#loggedIn").removeClass("hidden");
                $("#loggedOut").addClass("hidden");
            } else {
                // if you're logged out
                $("#loggedOut").removeClass("hidden");
                $("#loggedIn").addClass("hidden");
            }
        }





        function signAgreement() {

            // contract scroll up
            $(document).scroll(function () {
                $("#draftContract .js-back-to-content").removeClass("visually-hidden");
            });

            $("#sign2").click(function (e) {
                e.preventDefault();
                //  check if this is on-boarding or not

                var today = new Date();
                var date = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();

                var signAgreementForID = localStorage.getItem("signAgreementFor")
                if (signAgreementForID == null) {
                    signAgreementForID = "0"
                }
                
                var orgToSign = signAgreementForID,
                    organisations = JSON.parse(localStorage.getItem("organisations"));

                existingDetails = JSON.parse(organisations[orgToSign]);
                existingDetails.signed = 1;
                existingDetails.date = date;

                organisations[orgToSign] = JSON.stringify(existingDetails);

                localStorage.setItem("organisations", JSON.stringify(organisations));

                var onboarding = JSON.parse(localStorage.getItem("onboarding"));
                window.location.href = "/sprint/{{sprint}}/account/organisations/index.html?newOrgSigned=y";

            });
        };


        function renameAccount() {
            $(".error-summary").hide();
            $(".form-group .error-message").hide();
            $(".form-group").removeClass("error");

            $(".button").click(function (e) {
                e.preventDefault();
                var newName = $("#new-name").val();

                if (newName == "") {
                    //show error
                    $(".error-summary").show();
                    $(".form-group .error-message").show();
                    $("#newName").addClass("error");
                } else {
                    localStorage.setItem("organisation-name", JSON.stringify(newName));
                    window.location = document.referrer + '?name-changed=1';
                };
            });
        }

        function areYouReady() {
            if ($('input[name=radio-group]:checked', 'form').val() == "no") {
                window.location.href = "/sprint/{{sprint}}/onboarding/not-ready.html";
            } else {
                window.location.href = "/sprint/{{sprint}}/onboarding/zxcvbn.html";
            }
        }

        function orgQuestion() {
            if ($('input[name=radio-group]:checked', 'form').val() == "charity") {
                window.location.href = "/sprint/{{sprint}}/account/organisations/addcharity.html";
            } else {
                window.location.href = "/sprint/{{sprint}}/account/organisations/public-sector-searh.html";
            }
        };

        function chQuestion() {
            if ($('input[name=radio-group]:checked', 'form').val() == "yes") {
                window.location.href = "/sprint/{{sprint}}/account/organisations/companieshouse.html?orgtype=limited";
            } else {
                window.location.href = "/sprint/{{sprint}}/account/organisations/add.html";
            }

        }





        function searchThis() {
            
            $.ajax({
                type: "GET",
                url: XMLSource,
                dataType: "xml",
                success: function (xml) {
                    loadstnlocation(xml)
                },
                error: function (request, error) {
                    //console.log(arguments);
                    console.log("something broke in the searchThis function");
                    //alert(" Can't do because: " + error);
                }
            });
        }

        function loadstnlocation(xmlData) {
            i = 0;
            var row;
            var searchExp = "";

            $(xmlData).find('row').each(function () {

                i++;

                var iName = $(this).find('iName').text();
                var iAddress = $(this).find('iAddress').text();
                var iType = $(this).find('iType').text();
                //        console.log(iName);
                //        console.log(iType);
                //        console.log("address" + iAddress);



                //Format the keyword expression
                var exp = new RegExp(keyword, "gi");
                searchExp = iName.match(exp);

                if (searchExp != null) {
                    stn += '<li data-id=' + i + '"><h2 class="heading-medium"><a href="/sprint/{{sprint}}/account/organisations/confirm.html?name=' + iName + '">' + iName + '</a></h2>';
                    stn += '<dl class="result-data-list"><dt><b>Address</b></dt><dd>'
                    stn += '<address class="form-hint">' + iAddress + '</address></dd>';
                    stn += '<dt><b>Type</b><dd><span class="type">' + iType + '</span></dd></dl></li>';
                };
            });

            showList(stn);

        }



        function showList(stn) {
            
            //Populate on page
            var contentTop = '<ul class="list list-links">';
            var contentBottom = '</ul>';
            var helpText = "        <h5 class='heading-small'>Can't find your organisation?</h5><p> You can <a href='manual-input.html'>add it manually here</a>.</p>";
            $('#results').html(contentTop + stn + contentBottom + helpText);
            getPublicSearchCount(keyword);
            disabledAddedPublicOrgs();

            $("ul a").click(function (e) {
                e.preventDefault();
                var orgName = $(this).text();
                var href = this.href;
                //addOrg(orgName);
                localStorage.setItem("organisation-name", orgName);
                window.location.href = href;
            })

        }


        function getPublicSearchCount(keyword) {
            $("#search-main").val(keyword);
            var count = $(".list-links li").length;
            $(".count").text(count);
        };

        function disabledAddedPublicOrgs() {
            var psAdded = 3;

            var name = $(".list-links li:nth-child(" + psAdded + ") a").text();
            var iAddress = $(".list-links li:nth-child(" + psAdded + ") address").text();
            var iType = $(".list-links li:nth-child(" + psAdded + ") span.type").text();

            $(".list-links li:nth-child(" + psAdded + ")").replaceWith("<li class='added'><div>already added</div><h2 class='heading-medium'>" + name + "</h2><dl class='result-data-list'><dt><b>Address</b></dt><dd><address>" + iAddress + "</dd><dt><b>Type</b></dt><dd><span class='type'>" + iType + "</span></dd></dl><li>");
        }




        // get & set sprint
        var sprint = {{sprint}}

        localStorage.setItem("sprint", JSON.stringify(sprint));


        //get url variables    
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) {
                    return pair[1];
                }
            }
            return (false);
        }
        var accepted = getQueryVariable("accepted");
        var invitesent = getQueryVariable("invitesent");
        var inviteresent = getQueryVariable("inviteresent");
        var invitecancelled = getQueryVariable("invitecancelled");
        var rolechange = getQueryVariable("rolechange");
        var userdeleted = getQueryVariable("userdeleted");
        var PAYEremoved = getQueryVariable("PAYEremoved");
        var PAYEadded = getQueryVariable("PAYEadded");
        var rolechange = getQueryVariable("rolechange");
        var flow = getQueryVariable("flow");
        var newOrg = getQueryVariable("newOrg");
        var newOrgSigned = getQueryVariable("newOrgSigned");
        var agreementState = getQueryVariable("agreementState");
        var newLevyAccount = getQueryVariable("newLevyAccount");
        var sessionState = JSON.parse(localStorage.getItem("sessionState"));
        var govgateway = getQueryVariable("govgateway");
        var resetPassword = getQueryVariable("resetPassword");
        var ab = getQueryVariable("ab");
        var sprintIteration = JSON.parse(localStorage.getItem("sprint-number"));
        var userEmail = JSON.parse(localStorage.getItem("email-address"));
        var emailUpdated = getQueryVariable("emailUpdated");
        var nameUpdated = getQueryVariable("nameUpdated");
        var accountCreated = getQueryVariable("accountCreated");
        var orgType = getQueryVariable("orgtype");
        var organisationName = getQueryVariable("name");
        var organisationNameNew = getQueryVariable("name-changed");
        var removeMsg = getQueryVariable("removeMsg");



        if (organisationName != "" || null) {
            var organisationNameStripped = organisationName.replace(/%20/g, " ");
            localStorage.setItem("organisation-name", JSON.stringify(organisationNameStripped));
        }

        if (organisationNameNew == "1") {
            $("#content").prepend("<div class='govuk-box-highlight'><h2 class='bold-large'>Account renamed</h2><p>You successfully updated the account name</p></div>");
        };

        // globals
        //user details
        var user = {}
        user.firstName = JSON.parse(localStorage.getItem('user.firstName'));
        user.lastName = JSON.parse(localStorage.getItem('user.lastName'));
        user.email = JSON.parse(localStorage.getItem('user.email'));
        user.password = JSON.parse(localStorage.getItem('user.password'));
        user.jobTitle = JSON.parse(localStorage.getItem('user.jobTitle'));
        //user states
        user.NDA = JSON.parse(localStorage.getItem('userNDA'));
        user.state = JSON.parse(localStorage.getItem('userState'));
        user.type = JSON.parse(localStorage.getItem('userType'));

        // company details
        //var companyName = JSON.parse(localStorage.getItem('companyName'));
        //var companiesHouseNumber = JSON.parse(localStorage.getItem('companiesHouseNumber'));
        // agreement object {type:"",id:"",state:""} type=org type id=unique number state=is it signed?
        //localStorage.setItem('agreements')
        //var agreements = JSON.parse(localStorage.getItem('agreements'));

        //var companyData = [{companiesHouseNumber: 342342342, companyName:"ACME Ltd",agreement:0}]
        var companyData = [{
            companiesHouseNumber: null,
            companyName: null,
            agreement: null
        }]

        localStorage.setItem('companyData', JSON.stringify(companyData));
        //  console.log(JSON.parse(localStorage.getItem('companyData')));

        //var payeSchemes = [{ schemeNumber: "324234/AS1", englishPercentage: 80}, {schemeNumber:"234234234",englishPercentage: 90}];
        var payeSchemes = [{
            schemeNumber: null,
            englishPercentage: null
        }, {
            schemeNumber: null,
            englishPercentage: null
        }];
        localStorage.setItem('payeSchemes', JSON.stringify(payeSchemes));
        //    console.log(JSON.parse(localStorage.getItem('payeSchemes')));

        // useful methods

        //back button
        function goBack() {
            window.history.back();
        }

        $(".link-back").click(function (e) {
            e.preventDefault();
            window.history.back();
        })


        // Sprint {{sprint}}

        if ($("main").hasClass("index") == true) {
            localStorage.setItem('payeCount', 0)
        };


        // used service before page
        $(".onboarding-index .button").click(function (e) {
            e.preventDefault();
            if ($('input[name=radio-group]:checked', 'form').val() == "new") {
                //set cookie about on-boarding
                localStorage.setItem('onboarding', "1");
                window.location.href = "/sprint/{{sprint}}/onboarding/before-you-start.html";
            } else {
                window.location.href = "/sprint/{{sprint}}/user/login.html";
                localStorage.setItem('onboarding', "0");
            }
        })

        // adding paye scheme
        $(".sprint-11 .gateway-auth .button").click(function (e) {
            e.preventDefault();
            var payeCount = localStorage.getItem('payeCount');
            payeCount++;
            localStorage.setItem('payeCount', payeCount);
            window.location.href = "/sprint/{{sprint}}/onboarding/paye-check.html";
        });

        // add paye scheme loop
        $(".sprint-11 .paye-check .button").click(function (e) {
            e.preventDefault();
            if ($('input[name=radio-group]:checked', 'form').val() == "addMore") {
                window.location.href = "/sprint/{{sprint}}/onboarding/gateway-login.html";
            } else {
                window.location.href = "/sprint/{{sprint}}/account/dashboard/index.html?newLevyAccount=y";
            }
        });


        // add correct number of paye schemes to page
        if ($("main").hasClass("paye-check") == true) {
            var i = parseInt(localStorage.getItem('payeCount'));
            i++;
            $('.sprint-11 .paye-check table tr').hide();
            $('.sprint-11 .paye-check table#paye-check-2 tr:lt(' + i + ')').show()

            // remove a paye scheme    
            $("table a").click(function (e) {
                e.preventDefault();
                i--;
                localStorage.setItem('payeCount', i);
                location.reload();
            });
        };






        // notifications site wide
        if (newLevyAccount == "y") {
            $("#accountCreated").removeClass("hidden");
        }
        if (invitesent == "y") {
            $("#invitesent").removeClass("hidden");
        }
        if (userdeleted == "y") {
            $("#userdeleted").removeClass("hidden");
        };
        if (inviteresent == "y") {
            $("#inviteresent").removeClass("hidden");
        };
        if (invitecancelled == "y") {
            $("#invitecancelled").removeClass("hidden");
        };
        if (rolechange == "y") {
            $("#rolechange").removeClass("hidden");
        }
        if (PAYEremoved == "y") {
            $("#PAYEremoved").removeClass("hidden");
        }
        if (PAYEadded == "y") {
            $("#PAYEadded").removeClass("hidden");
        }
        if (accountCreated == "y") {
            $("#accountCreated").removeClass("hidden");
        }
        if (newOrgSigned == "y") {
            $("#org").removeClass("hidden");
        }
        if (newOrgSigned == "n") {
            $("#orgNo").removeClass("hidden");
        }





        function passwordPeek() {
            var myElement = document.getElementById('peak');

            // create a simple instance
            // by default, it only adds horizontal recognizers
            var mc = new Hammer(myElement);

            // listen to events...
            mc.on("tap", function (ev) {
                // show helper text
                $(".peakHelp").show().delay(2500).fadeOut("slow");
                console.log("tapp");
            });
            mc.on("press", function (ev) {
                console.log("press down")
                $(".peakHelp").hide();
                $("#password").attr('type', 'text');
                $('.show-pw').text("Hide").addClass("hide-pw");
            });
            mc.on("pressup", function (ev) {
                console.log("press release")
                $("#password").attr('type', 'password');
                $('.show-pw').text("Peek").removeClass("hide-pw");
            });

            /*   $('.show-pw').on('mousedown mouseup', function mouseState(e) {
    if (e.type == "mousedown") {
        //code triggers on hold
        console.log("hold");
        $("#password").attr('type', 'text');
        $('.show-pw').text("Hide").addClass("hide-pw");
    } else {
        $("#password").attr('type', 'password');
        $('.show-pw').text("Peak").removeClass("hide-pw");
    }
});*/

        }

        $("#password").focusin(function () {
            $(".popover").slideDown("slow");
        });

        i = 0;
        $("#password input").keyup(function (e) {
            i++;
            var len = $("#password-input").val().length;
            alert(len);
            //var oneCharacter = newRegExp(^[A-Za-z]([A-Za-z]{2}|[A-Za-z][0-9]|[0-9]{2})[0-9]{0,6}$);
            var strongRegex = new RegExp("^(?=.{8,})(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*\\W).*$", "g");
            var mediumRegex = new RegExp("^(?=.{7,})(((?=.*[A-Z])(?=.*[a-z]))|((?=.*[A-Z])(?=.*[0-9]))|((?=.*[a-z])(?=.*[0-9]))).*$", "g");
            var enoughRegex = new RegExp("(?=.{6,}).*", "g");
            if (false == enoughRegex.test($(this).val())) {} else if (strongRegex.test($(this).val())) {} else if (mediumRegex.test($(this).val())) {
                $("#1char").removeClass("danger").addClass("success");
                $("#1char .fa").removeClass("fa-circle").addClass("fa-check-circle")
            } else if (len > 8) {
                $("#8num").removeClass("danger").addClass("success");
                $("#8num .fa").removeClass("fa-circle").addClass("fa-check-circle")
            } else {}
            return true;
        })
        i = 0;

        $(".password-strength span").hide();

        $("#passwordgroup input").keyup(function (e) {
            var password = $(this).val();
            var result = zxcvbn(password);
            console.log(result.score);
            var resultScore = result.score;


            switch (resultScore) {
            case 0:
                console.log("score is " + resultScore);
                $(".password-strength span").show();
                //$(".password-strength .veryweak").show();
                $(".password-strength.pw2 span").addClass("veryweak").css("width", "20%");
                $(".pw-strength").text("very weak");
                break;
            case 1:
                console.log("score is " + resultScore)
                    //$(".password-strength span").hide();
                    //$(".password-strength .veryweak, .password-strength .weak").show();
                $(".password-strength.pw2 span").removeClass().addClass("weak").css("width", "40%");
                $(".pw-strength").text("weak");
                break;
            case 2:
                console.log("score is " + resultScore)
                    //$(".password-strength span").hide();
                    ///$(".password-strength .veryweak, .password-strength .weak, .password-strength .good").show();
                $(".password-strength.pw2 span").removeClass().addClass("good").css("width", "60%");
                $(".pw-strength").text("good");
                break;
            case 3:
                console.log("score is " + resultScore)
                    //$(".password-strength span").hide();
                    //$(".password-strength .veryweak, .password-strength .weak, .password-strength .good, .password-strength .strong").show();
                $(".password-strength.pw2 span").removeClass().addClass("strong").css("width", "80%");
                $(".pw-strength").text("strong");
                break;
            case 4:
                console.log("score is " + resultScore)
                    //$(".password-strength span").hide();
                    //$(".password-strength .veryweak, .password-strength .weak, .password-strength .good, .password-strength .strong, .password-strength .verystrong").show();
                $(".password-strength.pw2 span").removeClass().addClass("verystrong").css("width", "100%");
                $(".pw-strength").text("very strong");
                break;
            }

        });


        function organisationName() {
            $(".organisation-name, .company-name").text(JSON.parse(localStorage.getItem("organisation-name")));
            $(".organisation-name, .company-name").val(JSON.parse(localStorage.getItem("organisation-name")));
        }

        function userName() {
            var userName = JSON.parse(localStorage.getItem('user.firstName'));
            if (userName =! null ) {
                $(".user-name").text(userName);    
            } else {
                JSON.parse(localStorage.setItem('user.firstName',"James King"));
                $(".user-name").text("James King");
            }
            
        }


        function today() {
            var monthNames = [
  "January", "February", "March",
  "April", "May", "June", "July",
  "August", "September", "October",
  "November", "December"
];

            var date = new Date();
            var day = date.getDate();
            var monthIndex = date.getMonth();
            var year = date.getFullYear();

            //console.log(day, monthNames[monthIndex], year);
            $(".today").text(day + ' ' + monthNames[monthIndex] + ' ' + year);
        }
        today();








        function organisationAdd() {
            $(".errror-summary").hide();
            $(".form-group").removeClass("error");
            $(".error-message, .error-summary").addClass("hidden");
            //localStorage.setItem("organisation-address", JSON.stringify("101 Aviation House"))           
            $(".panel").hide()
            $("label").click(function () {
                $(".panel").hide();
                $(this).next().show()
            })

            $("#submit-keywords, #search-submit button").click(function (e) {
                e.preventDefault();
                $("#public-sector-search").hide();
                $("#results-wrapper").removeClass("hidden");
                keyword = $("#input-keywords").val();
                stn = '';
                searchThis();
            });
        }
    
    console.log("end");

    });
</script>